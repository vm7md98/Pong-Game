<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="../CSS/game.css" />
  </head>
  <body>
    <div><a href="../index.html">Home</a></div>
    <div class="main">
      <div class="title">
        <h1>Pong Game</h1>
      </div>
      <!--Initialize the canvas here-->

      <canvas
        id="canvas1"
        width="900"
        height="500"
        style="border: 1px solid blue"
      >
      </canvas>

      <script>
        //Default canvas code
        var canvas = document.getElementById("canvas1");
        var ctx = canvas.getContext("2d");

        //perform animation
        var requestAnimationFrame =
          window.requestAnimationFrame ||
          window.mozRequestAnimationFrame ||
          window.webkitRequestAnimationFrame ||
          window.msRequestAnimationFrame;

        //Audio declaration
        var winEffect = new Audio("../Sound/sound.wav");

        //Shared players attributes
        var barWidth = 130;
        var barHeight = 15;
        var barColor = "white";
        var barSpeed = 5;

        //Player position
        var playerBarX = canvas.width / 2 - barWidth / 2;
        var playerBarY = canvas.height - barHeight;

        //AI position
        var AIBarX = canvas.width / 2 - barWidth / 2;
        var AIBarY = 0;

        //Ball attributes
        var ballX = canvas.width / 2;
        var ballY = canvas.height / 2;
        var ballRad = 7.5;
        var ballColor = "red";
        var ballSpeed = 1;

        //Ball movements
        var goUp = true;
        var goDown = false;
        var goRight = false;
        var goLeft = false;

        //Initialize score
        var playerScore = 0;
        var AIScore = 0;

        //Score conditions
        var scoreWin = 3;

        //Shared score attribute
        var scoreFont = "32px Clement";
        var scoreColor = "red";
        var scoreY = 50;

        //Stores the keystates
        var keys = [];

        //Event listener for multiple keys.
        document.body.addEventListener("keydown", function (e) {
          keys[e.keyCode] = true;
        });

        document.body.addEventListener("keyup", function (e) {
          keys[e.keyCode] = false;
        });

        //Function to draw the ball
        function drawCircle(x, y, radius, color) {
          ctx.beginPath();
          ctx.fillStyle = color;
          ctx.fillRect(x, y, 15, 15);
          ctx.closePath();
          ctx.fill();
        }

        //Function to control the ball movement
        function ballMovement() {
          if (goRight) {
            ballX += ballSpeed;
            // ballX = ballX + ballSpeed;
          }
          if (goLeft) {
            ballX -= ballSpeed;
            // ballX = ballX - ballSpeed;
          }
          if (goUp) {
            ballY -= ballSpeed;
          }

          if (goDown) {
            ballY += ballSpeed;
          }

          if (ballY <= 0) {
            goUp = false;
            goDown = true;
          }

          if (ballY >= canvas.height) {
            goDown = false;
            goUp = true;
          }

          if (ballX <= 0) {
            goLeft = false;
            goRight = true;
          }

          if (ballX >= canvas.width) {
            goRight = false;
            goLeft = true;
          }
        }

        //function for collision response
        function hitReaction(playerNum) {
          if (playerNum == 1) {
            goRight = true;
            goLeft = false;
          } else {
            goLeft = true;
            goRight = false;
          }

          rndnum = Math.random(); //this will generate a random number between 0 and 1

          if (rndnum <= 0.33) {
            goUp = true;
            goDown = false;
          } else if (rndnum >= 0.66) {
            goDown = true;
            goUp = false;
          } else {
            goDown = false;
            goUp = false;
          }
        }

        //scoring & check Score
        function scoring() {
          if (ballY  <= 0) {
            playerScore++;
            //playerScore = playerScore + 1;
            resetBall();
            goUp = true;
            goDown = false;
          }

          if (ballY >= canvas.height) {
            AIScore++;
            //AIScore = AIScore + 1;
            resetBall();
            goLeft = false;
            goRight = true;
          }
        }

        function checkScore() {
          if (playerScore == scoreWin) {
            winEffect.play();
            alert("You win!");
            playerScore = 0;
            AIScore = 0;
          }

          if (AIScore == scoreWin) {
            alert("Game Over. You Lose!");
            playerScore = 0;
            AIScore = 0;
          }
        }

        function drawText(text, x, y, font, color) {
          ctx.font = font;
          ctx.fillStyle = color;
          ctx.fillText(text, x, y);
        }

        function resetBall() {
          ballX = canvas.width / 2;
          ballY = canvas.height / 2;
        }

        function getDistance(barX, barY) {
          if (
            barX < ballX + ballRad &&
            barX + barWidth > ballX &&
            barY < ballY + ballRad &&
            barY + barHeight > ballY
          ) {
            return true;
          }
        }

        function barLimitCheck(barX, keyInput) {
          if (barX == 0 && keyInput == 37) {
            barSpeed = 0;
          } else if( (barX + barWidth == canvas.width) && keyInput == 39) {
            barSpeed = 0;
          } else {
            barSpeed = 5;
          }
        }
        function barMovement() {
          if (keys[39]) {
            barLimitCheck(playerBarX, 39);
            playerBarX += barSpeed;
          }
          if (keys[37]) {
            barLimitCheck(playerBarX, 37);
            playerBarX -= barSpeed;
          }
        }

        function aiMovement() {
          if (ballX > AIBarX + barWidth) {
            AIBarX+=2;
            // AIBarY +=1;
            // AIBarY = AIBarY + 1;
          } else if (ballX < AIBarX) {
            AIBarX-=2;
            // AIBarY -=1;
            // AIBarY = AIBarY - 1;
          }
        }

        function drawRectangle(x, y, width, height, color) {
          ctx.fillStyle = color;
          ctx.fillRect(x, y, width, height);
        }

        //Animation is carried out by this function.
        function animate() {
          //Clears the canvas.

          //Draws the black background.
          //drawRectangle(0,0,600,300,"black");
          drawRectangle(0, 0, canvas.width, canvas.height, "black");
          //drawRectangle(canvas.width/2,0,300,300,"blue");

          //Moves the ball.
          ballMovement();

          //Draws the ball.
          drawCircle(ballX, ballY, ballRad, ballColor);

          //Moves the player bars if keys are pressed.
          barMovement();

          //Moves the bar if no player is present
          aiMovement();

          //Scoring
          scoring();

          //Draws the player.
          drawRectangle(playerBarX, playerBarY, barWidth, barHeight, "orange");

          //Draws the AI.
          drawRectangle(AIBarX, AIBarY, barWidth, barHeight, "blue");

          //Draws player's score.
          drawText(
            playerScore,
            canvas.width / 2 - 25,
            scoreY,
            scoreFont,
            scoreColor
          );

          //Draws AI's score.
          drawText(
            AIScore,
            canvas.width / 2 + 25,
            scoreY,
            scoreFont,
            scoreColor
          );

          //Checks the score of the players.
          checkScore();

          //If the ball hits the bar
          if (getDistance(playerBarX, playerBarY)) {
            hitReaction(1);
          }

          if (getDistance(AIBarX, AIBarY)) {
            hitReaction(2);
          }

          //Go to next animation frame
          requestAnimationFrame(animate);
        }

        // Start the animation
        requestAnimationFrame(animate);
      </script>
    </div>
  </body>
</html>
